
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Direct beam iterations for LoKI &#8212; ESSsans</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=6867b9c9"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user-guide/loki/loki-direct-beam';</script>
    <script src="../../_static/anaconda-icon.js?v=461bdc62"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="LoKI: data reduction from Larmor detector test" href="loki-iofq.html" />
    <link rel="prev" title="LoKI" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="25.12.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.svg" class="logo__image only-light" alt="ESSsans - Home"/>
    <img src="../../_static/logo-dark.svg" class="logo__image only-dark pst-js-only" alt="ESSsans - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/essreduce">
    ESSreduce
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/plopp">
    Plopp
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/sciline">
    Sciline
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/scippneutron">
    ScippNeutron
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/scippnexus">
    ScippNexus
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/esssans" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/esssans/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/esssans" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/essreduce">
    ESSreduce
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/plopp">
    Plopp
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/sciline">
    Sciline
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/scippneutron">
    ScippNeutron
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/scippnexus">
    ScippNexus
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/esssans" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/esssans/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/esssans" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">LoKI</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Direct beam iterations for LoKI</a></li>
<li class="toctree-l2"><a class="reference internal" href="loki-iofq.html">LoKI: data reduction from Larmor detector test</a></li>
<li class="toctree-l2"><a class="reference internal" href="loki-reduction-ess.html">Loki workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow-widget-loki.html">Workflow widgets example</a></li>
<li class="toctree-l2"><a class="reference internal" href="loki-detector-diagnostics.html">LOKI Detector Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="loki-make-tof-lookup-table.html">Create a time-of-flight lookup table for LoKI</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../isis/index.html">ISIS instruments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../isis/sans2d.html">Sans2d Data Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isis/zoom.html">Zoom data reduction</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../common/index.html">Common tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../common/beam-center-finder.html">Beam center finder</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Create-and-configure-the-workflow">Create and configure the workflow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Configuring-data-to-load">Configuring data to load</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Finding-the-beam-center">Finding the beam center</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Expected-intensity-at-zero-Q">Expected intensity at zero Q</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#A-single-direct-beam-function-for-all-layers">A single direct beam function for all layers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Direct-beam-function-per-layer">Direct beam function per layer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Combining-multiple-runs-to-boost-signal">Combining multiple runs to boost signal</a></li>
</ul>
  </nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/user-guide/loki/loki-direct-beam.ipynb"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">LoKI</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Direct beam iterations for LoKI</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Direct-beam-iterations-for-LoKI">
<h1>Direct beam iterations for LoKI<a class="headerlink" href="#Direct-beam-iterations-for-LoKI" title="Link to this heading">#</a></h1>
<section id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Link to this heading">#</a></h2>
<p>This notebook is used to compute the direct beam function for the <a class="reference external" href="https://europeanspallationsource.se/instruments/loki">LoKI</a> detectors. It uses data recorded during the detector test at the Larmor instrument.</p>
<p><strong>Description of the procedure:</strong></p>
<p>The idea behind the direct beam iterations is to determine an efficiency of the detectors as a function of wavelength. To calculate this, it is possible to compute <span class="math notranslate nohighlight">\(I(Q)\)</span> for the full wavelength range, and for individual slices (bands) of the wavelength range. If the direct beam function used in the <span class="math notranslate nohighlight">\(I(Q)\)</span> computation is correct, then <span class="math notranslate nohighlight">\(I(Q)\)</span> curves for the full wavelength range and inside the bands should overlap.</p>
<p>In the following notebook, we will:</p>
<ol class="arabic simple">
<li><p>Create a workflow to compute <span class="math notranslate nohighlight">\(I(Q)\)</span> inside a set of wavelength bands (the number of wavelength bands will be the number of data points in the final direct beam function)</p></li>
<li><p>Create a flat direct beam function, as a function of wavelength, with wavelength bins corresponding to the wavelength bands</p></li>
<li><p>Calculate inside each band by how much one would have to multiply the final <span class="math notranslate nohighlight">\(I(Q)\)</span> so that the curve would overlap with the full-range curve (we compute the full-range data by making a copy of the workflow but setting only a single wavelength band that contains all wavelengths)</p></li>
<li><p>Multiply the direct beam values inside each wavelength band by this factor</p></li>
<li><p>Compare the full-range <span class="math notranslate nohighlight">\(I(Q)\)</span> to a theoretical reference and add the corresponding additional scaling to the direct beam function</p></li>
<li><p>Iterate until the changes to the direct beam function become small</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">scipp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plopp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ess</span><span class="w"> </span><span class="kn">import</span> <span class="n">sans</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ess</span><span class="w"> </span><span class="kn">import</span> <span class="n">loki</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ess.loki.data</span>  <span class="c1"># noqa: F401</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ess.sans.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-and-configure-the-workflow">
<h2>Create and configure the workflow<a class="headerlink" href="#Create-and-configure-the-workflow" title="Link to this heading">#</a></h2>
<p>We begin by creating the Loki workflow object (this is a <a class="reference external" href="https://scipp.github.io/sciline/generated/classes/sciline.Pipeline.html">sciline.Pipeline</a> which can be consulted for advanced usage). The files we use here come from a Loki detector test at Larmor, so we use the corresponding workflow:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span> <span class="o">=</span> <span class="n">loki</span><span class="o">.</span><span class="n">LokiAtLarmorWorkflow</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We configure the workflow be defining the series of masks filenames and bank names to reduce. In this case there is just a single bank:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">with_pixel_mask_filenames</span><span class="p">(</span>
    <span class="n">workflow</span><span class="p">,</span> <span class="n">masks</span><span class="o">=</span><span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_mask_filenames</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">NeXusDetectorName</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;larmor_detector&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Downloading file &#39;mask_new_July2022.xml&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/mask_new_July2022.xml&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
</pre></div></div>
</div>
<p>The workflow can be visualized as a graph. For readability we show only sub-workflow for computing <code class="docutils literal notranslate"><span class="pre">IofQ[Sample]</span></code>. The workflow can actually compute the full <code class="docutils literal notranslate"><span class="pre">BackgroundSubtractedIofQ</span></code>, which applies and equivalent workflow to the background run, before a subtraction step:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">IntensityQ</span><span class="p">[</span><span class="n">SampleRun</span><span class="p">],</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rankdir&#39;</span><span class="p">:</span> <span class="s1">&#39;LR&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_7_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_7_0.svg" />
</div>
</div>
<p>Note the red boxes which indicate missing input parameters. We can set these missing parameters, as well as parameters where we do not want to use the defaults:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wavelength binning parameters</span>
<span class="n">wavelength_min</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;angstrom&#39;</span><span class="p">)</span>
<span class="n">wavelength_max</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="mf">13.0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;angstrom&#39;</span><span class="p">)</span>
<span class="n">n_wavelength_bins</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">n_wavelength_bands</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">workflow</span><span class="p">[</span><span class="n">WavelengthBins</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
    <span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">wavelength_min</span><span class="p">,</span> <span class="n">wavelength_max</span><span class="p">,</span> <span class="n">n_wavelength_bins</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">)</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">WavelengthBands</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
    <span class="s1">&#39;wavelength&#39;</span><span class="p">,</span> <span class="n">wavelength_min</span><span class="p">,</span> <span class="n">wavelength_max</span><span class="p">,</span> <span class="n">n_wavelength_bands</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">)</span>


<span class="n">workflow</span><span class="p">[</span><span class="n">CorrectForGravity</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">UncertaintyBroadcastMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">UncertaintyBroadcastMode</span><span class="o">.</span><span class="n">upper_bound</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">ReturnEvents</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">workflow</span><span class="p">[</span><span class="n">QBins</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;1/angstrom&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Configuring-data-to-load">
<h2>Configuring data to load<a class="headerlink" href="#Configuring-data-to-load" title="Link to this heading">#</a></h2>
<p>We have not configured which files we want to load. In this tutorial, we use helpers to fetch the tutorial data which return the filenames of the cached files. In a real use case, you would set these parameters manually:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="p">[</span><span class="n">Filename</span><span class="p">[</span><span class="n">SampleRun</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_sample_run_60339</span><span class="p">()</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">Filename</span><span class="p">[</span><span class="n">BackgroundRun</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_background_run_60393</span><span class="p">()</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">Filename</span><span class="p">[</span><span class="n">TransmissionRun</span><span class="p">[</span><span class="n">SampleRun</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_sample_transmission_run</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">Filename</span><span class="p">[</span><span class="n">TransmissionRun</span><span class="p">[</span><span class="n">BackgroundRun</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_run_60392</span><span class="p">()</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">Filename</span><span class="p">[</span><span class="n">EmptyBeamRun</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_run_60392</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Downloading file &#39;60339-2022-02-28_2215.nxs&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/60339-2022-02-28_2215.nxs&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
Downloading file &#39;60393-2022-02-28_2215.nxs&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/60393-2022-02-28_2215.nxs&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
Downloading file &#39;60394-2022-02-28_2215.nxs&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/60394-2022-02-28_2215.nxs&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
Downloading file &#39;60392-2022-02-28_2215.nxs&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/60392-2022-02-28_2215.nxs&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
</pre></div></div>
</div>
</section>
<section id="Finding-the-beam-center">
<h2>Finding the beam center<a class="headerlink" href="#Finding-the-beam-center" title="Link to this heading">#</a></h2>
<p>Looking carefully at the workflow above, one will notice that there is a missing parameter from the workflow: the red box that contains the <code class="docutils literal notranslate"><span class="pre">BeamCenter</span></code> type. Before we can proceed with computing the direct beam function, we therefore have to first determine the center of the beam.</p>
<p>There are more details on how this is done in the <a class="reference internal" href="../common/beam-center-finder.html"><span class="doc">beam center finder notebook</span></a>, but for now we simply reuse the workflow (by making a copy), and inserting the provider that will compute the beam center.</p>
<p>For now, we compute the beam center only for the rear detector (named ‘larmor_detector’) but apply it to all banks (currently there is only one bank). The beam center may need to be computed or applied differently to each bank, see <a class="reference external" href="https://github.com/scipp/esssans/issues/28">scipp/esssans#28</a>. We use a center-of-mass approach to find the beam center:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">center</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">beam_center_from_center_of_mass</span><span class="p">(</span><span class="n">workflow</span><span class="p">)</span>
<span class="n">center</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><!-- Original source from -->
<!-- https://github.com/jsignell/xarray/blob/1d960933ab252e0f79f7e050e6c9261d55568057/xarray/static/html/icons-svg-inline.html -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<title>Show/Hide data repr</title>
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<title>Show/Hide attributes</title>
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg><style id="scipp-style-sheet">.sc-root{--sc-background-color0:var(--jp-layout-color0,#fff);--sc-background-color1:var(--jp-layout-color1,#fcfcfc);--sc-background-color2:var(--jp-layout-color2,#efefef);--sc-inverse-background-color0:var(--jp-inverse-layout-color4,#111);--sc-font-color0:var(--jp-content-font-color0,#000);--sc-font-color1:var(--jp-content-font-color1,#555);--sc-font-color2:var(--jp-content-font-color2,#888);--sc-font-color3:var(--jp-content-font-color3,#ccc);}body.vscode-dark .sc-root{--sc-font-color0:rgba(255,255,255,1);--sc-font-color1:rgba(255,255,255,0.70);--sc-font-color2:rgba(255,255,255,0.54);--sc-font-color3:rgba(255,255,255,0.38);--sc-border-color:#1F1F1F;--sc-disabled-color:#515151;--sc-background-color0:#111111;--sc-background-color1:#111111;--sc-background-color2:#313131;}.sc-wrap{font-size:14px;min-width:300px;max-width:800px;}.sc-var-attrs .sc-wrap{padding-left:3em;}.sc-header{padding-top:6px;padding-bottom:6px;margin-bottom:4px;border-bottom:solid 1px #ddd;}.sc-header > div,.sc-header > ul{display:inline;margin-top:0;margin-bottom:0;}.sc-obj-type,.sc-array-name{margin-left:2px;margin-right:10px;}.sc-obj-type{color:var(--sc-font-color1);}.sc-underlying-size{color:var(--sc-font-color2);}.sc-sections,.reveal .sc-sections{padding-left:0 !important;display:grid;grid-template-columns:150px auto auto auto 1fr 20px 20px;}.sc-section-item{display:contents;}.sc-section-item input{display:none;}.sc-section-item input:enabled + label{cursor:pointer;color:var(--sc-font-color1);}.sc-section-item input:enabled + label:hover{color:var(--sc-font-color0);}.sc-section-summary{grid-column:1;font-weight:500;}.sc-section-summary > span{display:inline-block;padding-left:0.5em;}.sc-section-summary-in:disabled + label{color:var(--sc-font-color1);}.sc-section-summary-in + label:before{display:inline-block;content:'►';font-size:11px;width:15px;text-align:center;}.sc-section-summary-in:disabled + label:before{color:var(--sc-font-color3);}.sc-section-summary-in:checked + label:before{content:'▼';}.sc-section-summary-in:checked + label > span{display:none;}.sc-section-summary,.sc-section-inline-details{padding-top:4px;padding-bottom:4px;}.sc-section-inline-details{grid-column:2 / 6;}.sc-section-details{display:none;grid-column:1 / -1;margin-bottom:5px;}.sc-section-summary-in:checked ~ .sc-section-details{display:contents;}.sc-array-wrap{grid-column:1 / -1;display:grid;grid-template-columns:20px auto;}.sc-array-wrap > label{grid-column:1;vertical-align:top;}.sc-preview{color:var(--sc-font-color2);}.sc-array-preview,.sc-array-data{padding:0 5px !important;grid-column:2;}.sc-array-data,.sc-array-in:checked ~ .sc-array-preview{display:none;}.sc-array-in:checked ~ .sc-array-data,.sc-array-preview{display:inline-block;}.sc-dim-list{display:inline-block !important;list-style:none;padding:0 !important;margin:0;}.sc-dim-list li{display:inline-block;padding:0;margin:0!important;}.sc-dim-list:before{content:'(';}.sc-dim-list:after{content:')';}.sc-dim-list li:not(:last-child):after{content:',';padding-right:5px;}.sc-dim-list li span,.sc-standalone-var-name > span span,.sc-var-name > span span{padding:0 !important;}.sc-aligned{font-weight:bold;}.sc-var-list,.sc-var-item,.reveal .sc-var-list,.reveal .sc-var-item{display:contents;}.sc-var-item > div,.sc-var-item label,.sc-var-item > .sc-var-name span{background-color:var(--sc-background-color1);margin-bottom:0;}.sc-var-item > .sc-var-name:hover span{padding-right:5px;}.sc-var-list > li:nth-child(odd) > div,.sc-var-list > li:nth-child(odd) > label,.sc-var-list > li:nth-child(odd) > .sc-var-name span{background-color:var(--sc-background-color2);}.sc-var-name{grid-column:1;}.sc-var-dims{grid-column:2;}.sc-var-dtype{grid-column:3;text-align:right;color:var(--sc-font-color2);}.sc-var-unit{grid-column:4;text-align:left;color:var(--sc-font-color1);max-width:50pt;text-overflow:ellipsis;}.sc-value-preview{grid-column:5;}.sc-var-preview-variances{text-align:right;}.sc-sections .sc-section-item .sc-section-summary,.sc-sections .sc-section-item .sc-section-inline-details,.sc-section-item .sc-var-list .sc-var-item > div,.sc-section-item .sc-var-list .sc-var-item > label,.sc-section-details .sc-var-list .sc-var-item > div,.sc-section-details .sc-var-list .sc-var-item > label{margin-top:0;margin-bottom:0;}.sc-var-name,.sc-var-dims,.sc-var-dtype,.sc-var-unit,.sc-preview,.sc-attrs dt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;}.sc-var-name:hover,.sc-var-dims:hover,.sc-var-dtype:hover,.sc-var-unit:hover,.sc-attrs dt:hover{overflow:visible;width:auto;z-index:1;}.sc-var-attrs{display:block;}.sc-var-data,.reveal .sc-var-data{display:none;}.sc-var-attrs,.sc-var-data{background-color:var(--sc-background-color0) !important;padding-bottom:5px !important;}.sc-var-attrs-in:checked ~ .sc-var-attrs{display:none;}.sc-var-data-in:checked ~ .sc-var-data{display:block;}.sc-var-data > table{float:right;}.sc-var-name span,.sc-var-data{padding-left:25px !important;}.sc-var-attrs,.sc-var-data{grid-column:1 / -1;}dl.sc-attrs{padding:0;margin:0;display:grid;grid-template-columns:125px auto;}.sc-attrs dt,dd{padding:0;margin:0;float:left;padding-right:10px;width:auto;}.sc-attrs dt{font-weight:normal;grid-column:1;}.sc-attrs dt:hover span{display:inline-block;padding-right:10px;}.sc-attrs dd{grid-column:2;white-space:pre-wrap;word-break:break-all;}.sc-icon-database,.sc-icon-file-text2{display:inline-block;vertical-align:middle;width:1em;height:1.5em !important;stroke-width:0;stroke:currentColor;fill:currentColor;}label.sc-hide-icon svg{opacity:0;}.sc-standalone-var-name{grid-column:1/3;}.sc-standalone-var-name span{padding-left:25px;padding-right:10px;}.sc-title{font-weight:bold;font-size:1.5em;}.sc-subtitle{font-weight:normal;font-style:italic;text-align:left;font-size:1.2em;padding:1px;}.sc-label{fill:var(--sc-font-color0,#444444);text-anchor:middle;}.sc-name{fill:var(--sc-font-color0,#111111);}.sc-inset-line{stroke:var(--sc-font-color1);stroke-width:0.05;stroke-dasharray:0.2,0.2;}.sc-log-wrap{height:25ex;resize:vertical;overflow-y:scroll;display:flex;flex-direction:column-reverse;border:1px solid;border-color:var(--jp-border-color2);background-color:var(--sc-background-color1);}div.sc-log{line-height:2.5ex;}table.sc-log{table-layout:auto;border-collapse:collapse;}tr.sc-log:nth-child(even){background-color:var(--sc-background-color0);}tr.sc-log > td{vertical-align:top;padding-bottom:0.5ex;}.sc-log-time-stamp{min-width:22ch;font-family:var(--jp-code-font-family);color:var(--sc-font-color2);}.sc-log-level{min-width:10ch;}tr.sc-log-debug td.sc-log-level{color:var(--jp-accent-color1);}tr.sc-log-info td.sc-log-level{color:var(--jp-info-color1);}tr.sc-log-warning td.sc-log-level{color:var(--jp-warn-color1);}tr.sc-log-error td.sc-log-level{font-weight:bold;color:var(--jp-error-color2);}tr.sc-log-critical td.sc-log-level{font-weight:bold;color:var(--sc-background-color0);background-color:var(--jp-error-color1);}.sc-log-message{white-space:pre-wrap;width:100%;}.sc-log-html-payload{white-space:normal;}.sc-log-name{padding-right:0.5em;text-align:right;white-space:pre-wrap;color:var(--sc-font-color3);}</style><div class='sc-wrap sc-root'><div class='sc-header'><div class='sc-obj-type'>scipp.Variable (336 Bytes)</div></div><ul class='sc-sections'><li class='sc-section-item'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-standalone-var-name'><span>()</span></div><div class='sc-var-dtype'>vector3</div><div class='sc-var-unit'>m</div><div class='sc-value-preview sc-preview'><span><div>[-0.02914868 -0.01816138  0.        ]</div></span></div><input id='attrs-bca4701b-89f1-4427-abe6-f30101933834' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-bca4701b-89f1-4427-abe6-f30101933834' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-3baa8108-435d-4f4f-b051-60a6978f30e9' class='sc-var-data-in' type='checkbox'><label for='data-3baa8108-435d-4f4f-b051-60a6978f30e9' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array([-0.02914868, -0.01816138,  0.        ])</pre></li></ul></li></ul></div></div></div>
</div>
<p>and set that value in our workflow</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="p">[</span><span class="n">BeamCenter</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span>
</pre></div>
</div>
</div>
</section>
<section id="Expected-intensity-at-zero-Q">
<h2>Expected intensity at zero Q<a class="headerlink" href="#Expected-intensity-at-zero-Q" title="Link to this heading">#</a></h2>
<p>The sample used in the experiment has a known <span class="math notranslate nohighlight">\(I(Q)\)</span> profile, and we need it to calibrate the absolute intensity of our <span class="math notranslate nohighlight">\(I(Q)\)</span> results (relative differences between wavelength band and full-range results are not sufficient).</p>
<p>We load this theoretical reference curve, and compute the <span class="math notranslate nohighlight">\(I_{0}\)</span> intensity at the lower <span class="math notranslate nohighlight">\(Q\)</span> bound of the range covered by the instrument.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipp.scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">Iq_theory</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load_hdf5</span><span class="p">(</span><span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_poly_gauss_I0</span><span class="p">())</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">Iq_theory</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span>
<span class="n">I0</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">midpoints</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">QBins</span><span class="p">)))</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">I0</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Downloading file &#39;PolyGauss_I0-50_Rg-60.h5&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/PolyGauss_I0-50_Rg-60.h5&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><!-- Original source from -->
<!-- https://github.com/jsignell/xarray/blob/1d960933ab252e0f79f7e050e6c9261d55568057/xarray/static/html/icons-svg-inline.html -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<title>Show/Hide data repr</title>
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<title>Show/Hide attributes</title>
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg><style id="scipp-style-sheet">.sc-root{--sc-background-color0:var(--jp-layout-color0,#fff);--sc-background-color1:var(--jp-layout-color1,#fcfcfc);--sc-background-color2:var(--jp-layout-color2,#efefef);--sc-inverse-background-color0:var(--jp-inverse-layout-color4,#111);--sc-font-color0:var(--jp-content-font-color0,#000);--sc-font-color1:var(--jp-content-font-color1,#555);--sc-font-color2:var(--jp-content-font-color2,#888);--sc-font-color3:var(--jp-content-font-color3,#ccc);}body.vscode-dark .sc-root{--sc-font-color0:rgba(255,255,255,1);--sc-font-color1:rgba(255,255,255,0.70);--sc-font-color2:rgba(255,255,255,0.54);--sc-font-color3:rgba(255,255,255,0.38);--sc-border-color:#1F1F1F;--sc-disabled-color:#515151;--sc-background-color0:#111111;--sc-background-color1:#111111;--sc-background-color2:#313131;}.sc-wrap{font-size:14px;min-width:300px;max-width:800px;}.sc-var-attrs .sc-wrap{padding-left:3em;}.sc-header{padding-top:6px;padding-bottom:6px;margin-bottom:4px;border-bottom:solid 1px #ddd;}.sc-header > div,.sc-header > ul{display:inline;margin-top:0;margin-bottom:0;}.sc-obj-type,.sc-array-name{margin-left:2px;margin-right:10px;}.sc-obj-type{color:var(--sc-font-color1);}.sc-underlying-size{color:var(--sc-font-color2);}.sc-sections,.reveal .sc-sections{padding-left:0 !important;display:grid;grid-template-columns:150px auto auto auto 1fr 20px 20px;}.sc-section-item{display:contents;}.sc-section-item input{display:none;}.sc-section-item input:enabled + label{cursor:pointer;color:var(--sc-font-color1);}.sc-section-item input:enabled + label:hover{color:var(--sc-font-color0);}.sc-section-summary{grid-column:1;font-weight:500;}.sc-section-summary > span{display:inline-block;padding-left:0.5em;}.sc-section-summary-in:disabled + label{color:var(--sc-font-color1);}.sc-section-summary-in + label:before{display:inline-block;content:'►';font-size:11px;width:15px;text-align:center;}.sc-section-summary-in:disabled + label:before{color:var(--sc-font-color3);}.sc-section-summary-in:checked + label:before{content:'▼';}.sc-section-summary-in:checked + label > span{display:none;}.sc-section-summary,.sc-section-inline-details{padding-top:4px;padding-bottom:4px;}.sc-section-inline-details{grid-column:2 / 6;}.sc-section-details{display:none;grid-column:1 / -1;margin-bottom:5px;}.sc-section-summary-in:checked ~ .sc-section-details{display:contents;}.sc-array-wrap{grid-column:1 / -1;display:grid;grid-template-columns:20px auto;}.sc-array-wrap > label{grid-column:1;vertical-align:top;}.sc-preview{color:var(--sc-font-color2);}.sc-array-preview,.sc-array-data{padding:0 5px !important;grid-column:2;}.sc-array-data,.sc-array-in:checked ~ .sc-array-preview{display:none;}.sc-array-in:checked ~ .sc-array-data,.sc-array-preview{display:inline-block;}.sc-dim-list{display:inline-block !important;list-style:none;padding:0 !important;margin:0;}.sc-dim-list li{display:inline-block;padding:0;margin:0!important;}.sc-dim-list:before{content:'(';}.sc-dim-list:after{content:')';}.sc-dim-list li:not(:last-child):after{content:',';padding-right:5px;}.sc-dim-list li span,.sc-standalone-var-name > span span,.sc-var-name > span span{padding:0 !important;}.sc-aligned{font-weight:bold;}.sc-var-list,.sc-var-item,.reveal .sc-var-list,.reveal .sc-var-item{display:contents;}.sc-var-item > div,.sc-var-item label,.sc-var-item > .sc-var-name span{background-color:var(--sc-background-color1);margin-bottom:0;}.sc-var-item > .sc-var-name:hover span{padding-right:5px;}.sc-var-list > li:nth-child(odd) > div,.sc-var-list > li:nth-child(odd) > label,.sc-var-list > li:nth-child(odd) > .sc-var-name span{background-color:var(--sc-background-color2);}.sc-var-name{grid-column:1;}.sc-var-dims{grid-column:2;}.sc-var-dtype{grid-column:3;text-align:right;color:var(--sc-font-color2);}.sc-var-unit{grid-column:4;text-align:left;color:var(--sc-font-color1);max-width:50pt;text-overflow:ellipsis;}.sc-value-preview{grid-column:5;}.sc-var-preview-variances{text-align:right;}.sc-sections .sc-section-item .sc-section-summary,.sc-sections .sc-section-item .sc-section-inline-details,.sc-section-item .sc-var-list .sc-var-item > div,.sc-section-item .sc-var-list .sc-var-item > label,.sc-section-details .sc-var-list .sc-var-item > div,.sc-section-details .sc-var-list .sc-var-item > label{margin-top:0;margin-bottom:0;}.sc-var-name,.sc-var-dims,.sc-var-dtype,.sc-var-unit,.sc-preview,.sc-attrs dt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:10px;}.sc-var-name:hover,.sc-var-dims:hover,.sc-var-dtype:hover,.sc-var-unit:hover,.sc-attrs dt:hover{overflow:visible;width:auto;z-index:1;}.sc-var-attrs{display:block;}.sc-var-data,.reveal .sc-var-data{display:none;}.sc-var-attrs,.sc-var-data{background-color:var(--sc-background-color0) !important;padding-bottom:5px !important;}.sc-var-attrs-in:checked ~ .sc-var-attrs{display:none;}.sc-var-data-in:checked ~ .sc-var-data{display:block;}.sc-var-data > table{float:right;}.sc-var-name span,.sc-var-data{padding-left:25px !important;}.sc-var-attrs,.sc-var-data{grid-column:1 / -1;}dl.sc-attrs{padding:0;margin:0;display:grid;grid-template-columns:125px auto;}.sc-attrs dt,dd{padding:0;margin:0;float:left;padding-right:10px;width:auto;}.sc-attrs dt{font-weight:normal;grid-column:1;}.sc-attrs dt:hover span{display:inline-block;padding-right:10px;}.sc-attrs dd{grid-column:2;white-space:pre-wrap;word-break:break-all;}.sc-icon-database,.sc-icon-file-text2{display:inline-block;vertical-align:middle;width:1em;height:1.5em !important;stroke-width:0;stroke:currentColor;fill:currentColor;}label.sc-hide-icon svg{opacity:0;}.sc-standalone-var-name{grid-column:1/3;}.sc-standalone-var-name span{padding-left:25px;padding-right:10px;}.sc-title{font-weight:bold;font-size:1.5em;}.sc-subtitle{font-weight:normal;font-style:italic;text-align:left;font-size:1.2em;padding:1px;}.sc-label{fill:var(--sc-font-color0,#444444);text-anchor:middle;}.sc-name{fill:var(--sc-font-color0,#111111);}.sc-inset-line{stroke:var(--sc-font-color1);stroke-width:0.05;stroke-dasharray:0.2,0.2;}.sc-log-wrap{height:25ex;resize:vertical;overflow-y:scroll;display:flex;flex-direction:column-reverse;border:1px solid;border-color:var(--jp-border-color2);background-color:var(--sc-background-color1);}div.sc-log{line-height:2.5ex;}table.sc-log{table-layout:auto;border-collapse:collapse;}tr.sc-log:nth-child(even){background-color:var(--sc-background-color0);}tr.sc-log > td{vertical-align:top;padding-bottom:0.5ex;}.sc-log-time-stamp{min-width:22ch;font-family:var(--jp-code-font-family);color:var(--sc-font-color2);}.sc-log-level{min-width:10ch;}tr.sc-log-debug td.sc-log-level{color:var(--jp-accent-color1);}tr.sc-log-info td.sc-log-level{color:var(--jp-info-color1);}tr.sc-log-warning td.sc-log-level{color:var(--jp-warn-color1);}tr.sc-log-error td.sc-log-level{font-weight:bold;color:var(--jp-error-color2);}tr.sc-log-critical td.sc-log-level{font-weight:bold;color:var(--sc-background-color0);background-color:var(--jp-error-color1);}.sc-log-message{white-space:pre-wrap;width:100%;}.sc-log-html-payload{white-space:normal;}.sc-log-name{padding-right:0.5em;text-align:right;white-space:pre-wrap;color:var(--sc-font-color3);}</style><div class='sc-wrap sc-root'><div class='sc-header'><div class='sc-obj-type'>scipp.Variable (264 Bytes <span class='sc-underlying-size'>out of 1.03 KB</span>)</div></div><ul class='sc-sections'><li class='sc-section-item'><ul class='sc-var-list'><li class='sc-var-item'><div class='sc-standalone-var-name'><span>()</span></div><div class='sc-var-dtype'>float64</div><div class='sc-var-unit'>𝟙</div><div class='sc-value-preview sc-preview'><span><div>43.19421720556363</div></span></div><input id='attrs-c70f7c8c-2e7b-4746-bb0a-6518993207ae' class='sc-var-attrs-in' type='checkbox' disabled><label for='attrs-c70f7c8c-2e7b-4746-bb0a-6518993207ae' class='sc-hide-icon' title='Show/Hide attributes'><svg class='icon sc-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-54484c41-4175-475e-b689-3ec872c9be11' class='sc-var-data-in' type='checkbox'><label for='data-54484c41-4175-475e-b689-3ec872c9be11' title='Show/Hide data repr'><svg class='icon sc-icon-database'><use xlink:href='#icon-database'></use></svg></label><pre class='sc-var-data'>Values:<br>array(43.19421721)</pre></li></ul></li></ul></div></div></div>
</div>
</section>
<section id="A-single-direct-beam-function-for-all-layers">
<h2>A single direct beam function for all layers<a class="headerlink" href="#A-single-direct-beam-function-for-all-layers" title="Link to this heading">#</a></h2>
<p>As a first pass, we compute a single direct beam function for all the detector pixels combined.</p>
<p>We compute the <span class="math notranslate nohighlight">\(I(Q)\)</span> inside the wavelength bands and the full wavelength range, derive a direct beam factor per wavelength band, and also add absolute scaling using the reference <span class="math notranslate nohighlight">\(I_{0}\)</span> value</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">direct_beam</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span> <span class="n">I0</span><span class="o">=</span><span class="n">I0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="c1"># Unpack the final result</span>
<span class="n">iofq_full</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;iofq_full&#39;</span><span class="p">]</span>
<span class="n">iofq_bands</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;iofq_bands&#39;</span><span class="p">]</span>
<span class="n">direct_beam_function</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direct_beam&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We now compare the <span class="math notranslate nohighlight">\(I(Q)\)</span> curves in each wavelength band to the one for the full wavelength range (black).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">{</span><span class="o">**</span><span class="n">sc</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">iofq_bands</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">),</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="n">iofq_full</span><span class="p">}},</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">},</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_21_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_21_0.svg" />
</div>
</div>
<p>The overlap is satisfactory, and we can now inspect the direct beam function we have computed:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">direct_beam_function</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_23_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_23_0.svg" />
</div>
</div>
<p>Finally, as a sanity check, we compare our final <span class="math notranslate nohighlight">\(I(Q)\)</span> for the full wavelength range to the theoretical reference:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">Iq_theory</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">iofq_full</span><span class="p">},</span>
    <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="s1">&#39;C0&#39;</span><span class="p">},</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_25_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_25_0.svg" />
</div>
</div>
</section>
<section id="Direct-beam-function-per-layer">
<h2>Direct beam function per layer<a class="headerlink" href="#Direct-beam-function-per-layer" title="Link to this heading">#</a></h2>
<p>The LoKI detector tubes are arranged in layers along the beam path, where the layers closest to the sample will receive most of the scattered neutrons, while occulting the layers behind them.</p>
<p>A refinement to the above procedure is to compute a direct beam function for each layer of tubes individually. We also use the 4 thick layers of tubes, but in principle, this could also be done for 28 different layers (made from the <code class="docutils literal notranslate"><span class="pre">layer</span></code> and <code class="docutils literal notranslate"><span class="pre">straw</span></code> dimensions) if a run with enough events is provided (or many runs are combined together).</p>
<p>The only other difference compared to the computation above is that we now want our final result to preserve the <code class="docutils literal notranslate"><span class="pre">'layer'</span></code> dimension, so that the dimensions of our result are <code class="docutils literal notranslate"><span class="pre">['layer',</span> <span class="pre">'Q']</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="p">[</span><span class="n">DimsToKeep</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now we are able to run the direct-beam iterations on a per-layer basis:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_layers</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">direct_beam</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span> <span class="n">I0</span><span class="o">=</span><span class="n">I0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="c1"># Unpack the final result</span>
<span class="n">iofq_full_layers</span> <span class="o">=</span> <span class="n">results_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;iofq_full&#39;</span><span class="p">]</span>
<span class="n">iofq_bands_layers</span> <span class="o">=</span> <span class="n">results_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;iofq_bands&#39;</span><span class="p">]</span>
<span class="n">direct_beam_function_layers</span> <span class="o">=</span> <span class="n">results_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direct_beam&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>We can now inspect the wavelength slices for the 4 layers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plots</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="o">**</span><span class="n">sc</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">iofq_bands_layers</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">),</span>
            <span class="o">**</span><span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="n">iofq_full_layers</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">]},</span>
        <span class="p">},</span>
        <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">},</span>
        <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Layer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">]</span>

<span class="p">(</span><span class="n">plots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">plots</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">plots</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">plots</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_31_0.png" src="../../_images/user-guide_loki_loki-direct-beam_31_0.png" />
</div>
</div>
<p>Now the direct beam function inside each layer looks like:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">direct_beam_function_layers</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;wavelength&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_33_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_33_0.svg" />
</div>
</div>
<p>And finally, for completeness, we compare the <span class="math notranslate nohighlight">\(I(Q)\)</span> to the theoretical reference inside each layer.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layers</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">iofq_full_layers</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">Iq_theory</span><span class="p">},</span> <span class="o">**</span><span class="n">layers</span><span class="p">},</span>
    <span class="n">color</span><span class="o">=</span><span class="p">{</span>
        <span class="o">**</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="s1">&#39;darkgrey&#39;</span><span class="p">},</span>
        <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">)},</span>
    <span class="p">},</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_35_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_35_0.svg" />
</div>
</div>
</section>
<section id="Combining-multiple-runs-to-boost-signal">
<h2>Combining multiple runs to boost signal<a class="headerlink" href="#Combining-multiple-runs-to-boost-signal" title="Link to this heading">#</a></h2>
<p>It is common practise to combine the events from multiple runs to improve the statistics on the computed <span class="math notranslate nohighlight">\(I(Q)\)</span>, and thus obtain a more robust direct beam function.</p>
<p>To achieve this, we need to replace the <code class="docutils literal notranslate"><span class="pre">SampleRun</span></code> and <code class="docutils literal notranslate"><span class="pre">BackgroundRun</span></code> file names with parameter series. We then need to supply additional providers which will merge the events from the runs appropriately (note that these providers will merge both the detector and the monitor events).</p>
<p>We first define a list of file names for the sample and background runs (two files for each):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_runs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_sample_run_60250</span><span class="p">(),</span>
    <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_sample_run_60339</span><span class="p">(),</span>
<span class="p">]</span>
<span class="n">background_runs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_background_run_60248</span><span class="p">(),</span>
    <span class="n">loki</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loki_tutorial_background_run_60393</span><span class="p">(),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Downloading file &#39;60250-2022-02-28_2215.nxs&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/60250-2022-02-28_2215.nxs&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
Downloading file &#39;60248-2022-02-28_2215.nxs&#39; from &#39;https://public.esss.dk/groups/scipp/ess/loki/2/60248-2022-02-28_2215.nxs&#39; to &#39;/home/runner/.cache/ess/loki&#39;.
</pre></div></div>
</div>
<p>We modify the workflow, setting multiple background and sample runs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reset workflow</span>
<span class="n">workflow</span><span class="p">[</span><span class="n">DimsToKeep</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Transform base workflow to use multiple sample and background runs</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">with_background_runs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="n">background_runs</span><span class="p">)</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">with_sample_runs</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="n">sample_runs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If we now visualize the workflow, we can see that every step for the <code class="docutils literal notranslate"><span class="pre">SampleRun</span></code> and <code class="docutils literal notranslate"><span class="pre">BackgroundRun</span></code> branches are now replicated (drawn as 3D-looking boxes instead of flat rectangles, set <code class="docutils literal notranslate"><span class="pre">compact=False</span></code> to show flattened version). There is also the new <code class="docutils literal notranslate"><span class="pre">merge_contributions</span></code> step that combines the events from the two runs, just before the normalization.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">workflow</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">BackgroundSubtractedIofQ</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rankdir&#39;</span><span class="p">:</span> <span class="s1">&#39;LR&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_41_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_41_0.svg" />
</div>
</div>
<p>We run the direct beam iterations again and compare with our original results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">sans</span><span class="o">.</span><span class="n">direct_beam</span><span class="p">(</span><span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span> <span class="n">I0</span><span class="o">=</span><span class="n">I0</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="c1"># Unpack the final result</span>
<span class="n">iofq_full_new</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;iofq_full&#39;</span><span class="p">]</span>
<span class="n">iofq_bands_new</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;iofq_bands&#39;</span><span class="p">]</span>
<span class="n">direct_beam_function_new</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;direct_beam&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">({</span><span class="s1">&#39;one run&#39;</span><span class="p">:</span> <span class="n">direct_beam_function</span><span class="p">,</span> <span class="s1">&#39;two runs&#39;</span><span class="p">:</span> <span class="n">direct_beam_function_new</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_44_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_44_0.svg" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">Iq_theory</span><span class="p">,</span> <span class="s1">&#39;one run&#39;</span><span class="p">:</span> <span class="n">iofq_full</span><span class="p">,</span> <span class="s1">&#39;two runs&#39;</span><span class="p">:</span> <span class="n">iofq_full_new</span><span class="p">},</span>
    <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span> <span class="s1">&#39;one run&#39;</span><span class="p">:</span> <span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="s1">&#39;two runs&#39;</span><span class="p">:</span> <span class="s1">&#39;C1&#39;</span><span class="p">},</span>
    <span class="n">norm</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/user-guide_loki_loki-direct-beam_45_0.svg" src="../../_images/user-guide_loki_loki-direct-beam_45_0.svg" />
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">LoKI</p>
      </div>
    </a>
    <a class="right-next"
       href="loki-iofq.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">LoKI: data reduction from Larmor detector test</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025 Scipp contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
Current ESSsans version: 25.12.0 (<a href="https://github.com/scipp/esssans/releases">older versions</a>).</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>